Index: Lib/subprocess.py
===================================================================
--- Lib/subprocess.py	(revision 69620)
+++ Lib/subprocess.py	(revision 69621)
@@ -1103,6 +1103,9 @@
             if data != "":
                 os.waitpid(self.pid, 0)
                 child_exception = pickle.loads(data)
+                for fd in (p2cwrite, c2pread, errread):
+                    if fd is not None:
+                        os.close(fd)
                 raise child_exception
 
 
Index: Lib/test/test_subprocess.py
===================================================================
--- Lib/test/test_subprocess.py	(revision 69620)
+++ Lib/test/test_subprocess.py	(revision 69621)
@@ -486,6 +486,22 @@
         else:
             self.fail("Expected TypeError")
 
+    def test_leaking_fds_on_error(self):
+        # see bug #5179: Popen leaks file descriptors to PIPEs if
+        # the child fails to execute; this will eventually exhaust
+        # the maximum number of open fds. 1024 seems a very common
+        # value for that limit, but Windows has 2048, so we loop
+        # 1024 times (each call leaked two fds).
+        for i in range(1024):
+            try:
+                subprocess.Popen(['nonexisting_i_hope'],
+                                 stdout=subprocess.PIPE,
+                                 stderr=subprocess.PIPE)
+            # Windows raises IOError
+            except (IOError, OSError), err:
+                if err.errno != 2:  # ignore "no such file"
+                    raise
+
     #
     # POSIX tests
     #

Property changes on: .
___________________________________________________________________
Modified: svnmerge-integrated
   - /python/trunk:1-66720,66723-66743,66746-66751,66753-66755,66757-66762,66766-66767,66769-66790,66793-66821,66824-66831,66833-66835,66837-66851,66853-66856,66858-66867,66869-66877,66879-66893,66895-66901,66903-66911,66913-66988,66990-66993,66995-67012,67014,67016-67048,67050-67064,67066-67170,67172-67225,67227-67233,67235-67286,67288-67341,67343-67347,67350-67352,67354-67395,67397-67406,67408-67410,67412-67441,67443-67510,67512-67520,67522-67535,67538-67542,67544-67571,67573-67583,67585-67586,67588-67600,67602-67613,67615-67627,67629-67817,67819-67821,67823-67849,67851-67856,67858-67901,67903-67945,67947-67953,67955-67975,67977,67981-67984,67986-68088,68090-68091,68093-68118,68120-68131,68133-68149,68151-68152,68154-68155,68157,68159-68162,68164-68166,68168-68175,68177-68202,68204-68207,68210-68222,68232,68276,68288-68295,68297-68298,68300-68301,68303,68305-68310,68312-68313,68315-68318,68320-68380,68382-68394,68396-68414,68416-68424,68426-68431,68433-68454,68456-68457,68463-68475,68477-68483,68486,68488-68495,68497,68499-68515,68521-68531,68533-68541,68543,68547-68558,68561,68563-68564,68570,68572-68581,68583-68584,68589,68610-68617,68619-68622,68625-68627,68629-68632,68634-68647,68649,68661,68678,68708,68755,68779,68813-68825,68827-68828,68830,68832-68838,68841,68844,68846-68849,68851-68852,68854-68858,68860-68861,68863-68873,68875-68880,68882-68883,68885-68891,68893-68914,68916-68924,68926,68928,68930-68932,68934-68940,68944,68946-68952,68954-68963,68965-68972,68974-68984,68986-68997,68999-69000,69002,69004-69009,69011,69013,69015-69017,69019-69022,69024-69038,69040-69049,69051-69052,69054-69059,69064-69069,69071-69073,69075-69079,69081-69084,69086,69088-69111,69114-69128,69132-69133,69135-69138,69142,69144-69145,69147-69148,69150-69153,69160,69162-69168,69170-69194,69196-69210,69213-69226,69228-69236,69238-69239,69241,69243-69251,69254-69256,69258-69259,69261,69263-69267,69269-69270,69274-69275,69277-69284,69286-69287,69290-69292,69294,69296,69306-69314,69316-69321,69323,69325-69329,69333-69341,69343-69347,69349-69355,69357-69359,69361-69363,69367-69372,69375-69376,69378-69384,69386-69388,69390-69393,69395-69403,69405-69408,69411-69412,69416,69418,69421-69424,69426-69434,69436-69441,69444-69446,69448-69458,69461-69465,69468-69469,69471-69472,69475-69479,69482-69494,69496-69497,69499-69508,69510-69515,69517-69518,69523-69524,69526-69527,69529,69531-69546,69551,69562,69585,69598
   + /python/trunk:1-66720,66723-66743,66746-66751,66753-66755,66757-66762,66766-66767,66769-66790,66793-66821,66824-66831,66833-66835,66837-66851,66853-66856,66858-66867,66869-66877,66879-66893,66895-66901,66903-66911,66913-66988,66990-66993,66995-67012,67014,67016-67048,67050-67064,67066-67170,67172-67225,67227-67233,67235-67286,67288-67341,67343-67347,67350-67352,67354-67395,67397-67406,67408-67410,67412-67441,67443-67510,67512-67520,67522-67535,67538-67542,67544-67571,67573-67583,67585-67586,67588-67600,67602-67613,67615-67627,67629-67817,67819-67821,67823-67849,67851-67856,67858-67901,67903-67945,67947-67953,67955-67975,67977,67981-67984,67986-68088,68090-68091,68093-68118,68120-68131,68133-68149,68151-68152,68154-68155,68157,68159-68162,68164-68166,68168-68175,68177-68202,68204-68207,68210-68222,68232,68276,68288-68295,68297-68298,68300-68301,68303,68305-68310,68312-68313,68315-68318,68320-68380,68382-68394,68396-68414,68416-68424,68426-68431,68433-68454,68456-68457,68463-68475,68477-68483,68486,68488-68495,68497,68499-68515,68521-68531,68533-68541,68543,68547-68558,68561,68563-68564,68570,68572-68581,68583-68584,68589,68610-68617,68619-68622,68625-68627,68629-68632,68634-68647,68649,68661,68678,68708,68755,68779,68813-68825,68827-68828,68830,68832-68838,68841,68844,68846-68849,68851-68852,68854-68858,68860-68861,68863-68873,68875-68880,68882-68883,68885-68891,68893-68914,68916-68924,68926,68928,68930-68932,68934-68940,68944,68946-68952,68954-68963,68965-68972,68974-68984,68986-68997,68999-69000,69002,69004-69009,69011,69013,69015-69017,69019-69022,69024-69038,69040-69049,69051-69052,69054-69059,69064-69069,69071-69073,69075-69079,69081-69084,69086,69088-69111,69114-69128,69132-69133,69135-69138,69142,69144-69145,69147-69148,69150-69153,69160,69162-69168,69170-69194,69196-69210,69213-69226,69228-69236,69238-69239,69241,69243-69251,69254-69256,69258-69259,69261,69263-69267,69269-69270,69274-69275,69277-69284,69286-69287,69290-69292,69294,69296,69306-69314,69316-69321,69323,69325-69329,69333-69341,69343-69347,69349-69355,69357-69359,69361-69363,69367-69372,69375-69376,69378-69384,69386-69388,69390-69393,69395-69403,69405-69408,69411-69412,69416,69418,69421-69424,69426-69434,69436-69441,69444-69446,69448-69458,69461-69465,69468-69469,69471-69472,69475-69479,69482-69494,69496-69497,69499-69508,69510-69515,69517-69518,69523-69524,69526-69527,69529,69531-69546,69551,69562,69585,69598,69620

